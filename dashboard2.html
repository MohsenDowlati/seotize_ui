<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOTIZE Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
:root{--radius:12px;--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)}
[data-theme="dark"]{--bg:#0f172a;--sidebar:#1e293b;--card:#1e293b;--text:#e2e8f0;--text-light:#94a3b8;--border:#334155;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;--error:#ef4444;--warning:#f59e0b;--success:#10b981;--input-bg:#0f172a}
[data-theme="light"]{--bg:#f8fafc;--sidebar:#ffffff;--card:#ffffff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;--error:#ef4444;--warning:#f59e0b;--success:#10b981;--input-bg:#f1f5f9}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden;transition:all .3s}
.sidebar{width:260px;background:var(--sidebar);padding:1.5rem;display:flex;flex-direction:column;border-right:1px solid var(--border);transition:transform .3s}
.main{flex:1;overflow-y:auto;padding:2rem}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}
.logo{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2rem}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.875rem 1rem;border-radius:var(--radius);color:var(--text-light);font-weight:500;transition:all .2s;margin-bottom:.5rem;cursor:pointer}
.nav-item:hover{background:rgba(59,130,246,0.1);color:var(--primary)}
.nav-item.active{background:var(--primary);color:white}
.nav-item.active:hover{background:var(--primary-hover)}
.theme-toggle{width:40px;height:40px;border-radius:var(--radius);background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.theme-toggle:hover{border-color:var(--primary)}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem}
.card-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card-body{padding:1.5rem}
.btn{padding:.5rem 1rem;border-radius:var(--radius);font-weight:500;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--text);display:inline-flex;align-items:center;gap:.5rem}
.btn:hover{border-color:var(--primary);color:var(--primary)}
.btn-primary{background:var(--primary);color:white;border:none}
.btn-primary:hover{background:var(--primary-hover)}
.btn-sm{padding:.375rem .75rem;font-size:.875rem}
.btn-icon{width:36px;height:36px;padding:0;justify-content:center}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary))}
.stat-value{font-size:1.75rem;font-weight:700;margin:.5rem 0}
.stat-label{font-size:.875rem;color:var(--text-light)}
.stat-change{font-size:.75rem;color:var(--success);margin-top:.25rem}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:.875rem;text-align:left;border-bottom:1px solid var(--border)}
.table th{font-weight:600;color:var(--text-light);font-size:.875rem}
.table tr:hover{background:rgba(59,130,246,0.05)}
.badge{padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600;display:inline-flex;align-items:center;gap:.25rem}
.badge-primary{background:rgba(59,130,246,0.2);color:var(--primary)}
.badge-success{background:rgba(16,185,129,0.2);color:var(--success)}
.badge-warning{background:rgba(245,158,11,0.2);color:var(--warning)}
.badge-error{background:rgba(239,68,68,0.2);color:var(--error)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--card);border-radius:var(--radius);max-width:90%;width:600px;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:1.5rem}
.form-group{margin-bottom:1.25rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500;font-size:.875rem}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--input-bg);color:var(--text);transition:all .2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.form-textarea{resize:vertical;min-height:100px}
.toast{position:fixed;bottom:2rem;right:2rem;padding:1rem 1.5rem;border-radius:var(--radius);color:white;font-weight:500;transform:translateX(400px);transition:transform .3s;z-index:1000}
.toast.show{transform:translateX(0)}
.toast.success{background:var(--success)}
.toast.error{background:var(--error)}
.toast.warning{background:var(--warning)}
.section{display:none}
.section.active{display:block}
.loader{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:3rem;color:var(--text-light)}
.task-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1rem;cursor:pointer;transition:all .2s}
.task-item:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow)}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;margin-bottom:1.5rem}
.chart-container{height:300px;position:relative}
.compact-sessions{max-height:200px;overflow-y:auto}
.compact-sessions .table{font-size:.875rem}
.compact-sessions .table th,.compact-sessions .table td{padding:.5rem .875rem}
.hosting-menu{display:grid;grid-template-columns:200px 1fr;gap:1.5rem}
.hosting-nav{display:flex;flex-direction:column;gap:.5rem}
.hosting-nav-item{padding:.75rem 1rem;border-radius:var(--radius);background:var(--input-bg);cursor:pointer;transition:all .2s}
.hosting-nav-item:hover{background:var(--border)}
.hosting-nav-item.active{background:var(--primary);color:white}
.hosting-content{min-height:400px}
.location-preview{border:1px solid var(--border);border-radius:var(--radius);height:400px;overflow:hidden;position:relative;margin-bottom:1rem}
.location-preview iframe{width:100%;height:100%;border:0}
.location-overlay{position:absolute;inset:0;pointer-events:auto;cursor:crosshair}
.location-marker{position:absolute;width:20px;height:20px;background:var(--primary);border:2px solid white;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 2px 4px rgba(0,0,0,0.2);animation:pulse 2s infinite}
@keyframes pulse{0%{transform:translate(-50%,-50%) scale(1);opacity:1}50%{transform:translate(-50%,-50%) scale(1.2);opacity:0.8}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
.keyword-grid{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem}
.keyword-item{padding:.5rem 1rem;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .2s}
.keyword-item:hover{border-color:var(--primary);background:rgba(59,130,246,0.1)}
.keyword-item.selected{background:var(--primary);color:white;border-color:var(--primary)}
.mobile-toggle{display:none;position:fixed;top:1rem;left:1rem;z-index:100;width:40px;height:40px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);align-items:center;justify-content:center;cursor:pointer}
.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;margin-top:1rem}
.image-item{position:relative;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;aspect-ratio:1;cursor:pointer;transition:all .2s}
.image-item:hover{transform:scale(1.05);box-shadow:var(--shadow)}
.image-item img{width:100%;height:100%;object-fit:cover}
.image-stats{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);color:white;padding:.5rem;font-size:.75rem}
.domain-item{padding:1rem;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}
.domain-verified{border-color:var(--success)}
@media(max-width:768px){.mobile-toggle{display:flex}.sidebar{position:fixed;z-index:99;height:100%;transform:translateX(-100%)}.sidebar.show{transform:translateX(0)}.main{padding:1rem}.stat-grid{grid-template-columns:1fr 1fr}.analytics-grid{grid-template-columns:1fr}.modal-content{width:95%}.hosting-menu{grid-template-columns:1fr;gap:1rem}}
</style>
</head>
<body data-theme="dark">
    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <aside class="sidebar">
        <div class="logo">SEOTIZE</div>
        <nav>
            <div class="nav-item active" data-section="dashboard">üìä Dashboard</div>
            <div class="nav-item" data-section="tasks">üéØ SEO Tasks</div>
            <div class="nav-item" data-section="hosting">üåê Hosting</div>
            <div class="nav-item" data-section="billing">üí≥ Billing</div>
            <div class="nav-item" data-section="tools">üõ†Ô∏è SEO Tools</div>
        </nav>
        <div style="margin-top:auto;padding-top:1.5rem;border-top:1px solid var(--border)">
            <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
                <div style="width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:600" id="userAvatar">U</div>
                <div style="flex:1">
                    <div id="userEmail" style="font-size:.875rem;font-weight:500">Loading...</div>
                    <div id="userSince" style="font-size:.75rem;color:var(--text-light)"></div>
                </div>
            </div>
            <button class="btn" style="width:100%" onclick="logout()">Logout</button>
        </div>
    </aside>

    <main class="main">
        <div class="header">
            <h1 id="sectionTitle">Dashboard</h1>
            <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
        </div>

        <section class="section active" id="dashboard">
            <div class="analytics-grid">
                <div class="card">
                    <div class="card-header"><h3>Task Performance</h3></div>
                    <div class="card-body"><div class="chart-container"><canvas id="tasksChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Views by Country</h3></div>
                    <div class="card-body"><div class="chart-container"><canvas id="countryChart"></canvas></div></div>
                </div>
            </div>
            <div class="stat-grid" id="dashboardStats"></div>
            <div class="card">
                <div class="card-header">
                    <h3>Active Sessions</h3>
                    <span class="badge badge-primary" id="sessionCount">0 Active</span>
                </div>
                <div class="card-body compact-sessions">
                    <table class="table"><thead><tr><th>Location</th><th>IP</th><th>Created</th><th>Action</th></tr></thead><tbody id="sessionsTable"></tbody></table>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Recent Tasks</h3>
                    <button class="btn btn-sm" onclick="showSection('tasks')">View All</button>
                </div>
                <div class="card-body" id="recentActivity"></div>
            </div>
        </section>

        <section class="section" id="tasks">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
                <div class="stat-grid" style="flex:1;margin:0" id="taskStats"></div>
                <button class="btn btn-primary" onclick="showTaskModal()">‚ûï Create New Task</button>
            </div>
            <div class="card"><div class="card-body" id="tasksList"><div class="loader"></div></div></div>
        </section>

        <section class="section" id="hosting">
            <div class="hosting-menu">
                <div class="hosting-nav">
                    <div class="hosting-nav-item active" onclick="showHostingContent('overview')">üìä Overview</div>
                    <div class="hosting-nav-item" onclick="showHostingContent('images')">üñºÔ∏è Images</div>
                    <div class="hosting-nav-item" onclick="showHostingContent('articles')">üìù Articles</div>
                    <div class="hosting-nav-item" onclick="showHostingContent('domains')">üåê Domains</div>
                </div>
                <div class="hosting-content" id="hostingContent"></div>
            </div>
        </section>

        <section class="section" id="billing">
            <div class="stat-grid" id="billingStats"></div>
            <div class="card">
                <div class="card-header">
                    <h3>Transaction History</h3>
                    <select class="form-select" style="width:auto" onchange="loadBilling(this.value)">
                        <option value="all">All</option>
                        <option value="tasks">Tasks</option>
                        <option value="hosting">Hosting</option>
                    </select>
                </div>
                <div class="card-body"><table class="table"><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead><tbody id="billingTable"></tbody></table></div>
            </div>
        </section>

        <section class="section" id="tools">
            <div class="card">
                <div class="card-header"><h3>Keyword Research</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Enter URL for keyword analysis</label>
                        <div style="display:flex;gap:1rem">
                            <input type="url" class="form-input" id="keywordUrl" placeholder="https://example.com">
                            <button class="btn btn-primary" onclick="analyzeKeywords()">Analyze</button>
                        </div>
                    </div>
                    <div id="keywordResults"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>SERP Position Checker</h3></div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                        <div class="form-group">
                            <label class="form-label">Keyword</label>
                            <input type="text" class="form-input" id="serpKeyword" placeholder="SEO optimization">
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="url" class="form-input" id="serpUrl" placeholder="example.com">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="checkSerpPosition()">Check Position</button>
                    <div id="serpResults" style="margin-top:1.5rem"></div>
                </div>
            </div>
        </section>
    </main>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal</h3>
                <button class="btn-icon" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

<script>
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token');
let currentData = {};
let charts = {};

document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) {
        window.location.href = '/login.html';
        return;
    }
    setupNavigation();
    loadDashboard();
    gsap.from('.stat-card', {duration: 0.6, y: 20, opacity: 0, stagger: 0.1});
    gsap.from('.card', {duration: 0.8, y: 30, opacity: 0, stagger: 0.15, delay: 0.3});
});

function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const section = item.dataset.section;
            showSection(section);
        });
    });
}

function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(section).classList.add('active');
    document.querySelector(`[data-section="${section}"]`).classList.add('active');
    document.getElementById('sectionTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);
    gsap.from(`#${section}`, {duration: 0.5, opacity: 0, y: 20});

    switch(section) {
        case 'dashboard': loadDashboard(); break;
        case 'tasks': loadTasks(); break;
        case 'hosting': loadHosting(); break;
        case 'billing': loadBilling(); break;
    }

    if (window.innerWidth <= 768) document.querySelector('.sidebar').classList.remove('show');
}

function toggleTheme() {
    const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    document.body.dataset.theme = theme;
    localStorage.setItem('theme', theme);
}

function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('show');
}

async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Session-Token': sessionToken,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'API Error');
        return data;
    } catch (error) {
        showToast(error.message, 'error');
        throw error;
    }
}

async function loadDashboard() {
    try {
        const { data } = await api('/users/dashboard?page=1&page_size=50');
        currentData.user = data.user;

        document.getElementById('userEmail').textContent = data.user.email;
        document.getElementById('userAvatar').textContent = data.user.email[0].toUpperCase();
        document.getElementById('userSince').textContent = `Since ${new Date(data.user.created_at).toLocaleDateString()}`;

        const stats = [
            { label: 'Active Tasks', value: data.user.usage_summary.active_tasks, change: '+12%' },
            { label: 'Total Views', value: data.user.task_statistics.total_views.toLocaleString(), change: '+8%' },
            { label: 'Total Spent', value: `$${data.user.task_statistics.total_charge.toFixed(2)}` },
            { label: 'Available Budget', value: `$${data.user.task_statistics.available_charge.toFixed(2)}` }
        ];

        document.getElementById('dashboardStats').innerHTML = stats.map(stat => `
            <div class="stat-card">
                <div class="stat-label">${stat.label}</div>
                <div class="stat-value">${stat.value}</div>
                ${stat.change ? `<div class="stat-change">${stat.change}</div>` : ''}
            </div>
        `).join('');

        document.getElementById('sessionCount').textContent = `${data.user.sessions?.length || 0} Active`;
        document.getElementById('sessionsTable').innerHTML = data.user.sessions?.length ? data.user.sessions.map(session => `
            <tr>
                <td><span class="badge badge-primary">${session.country_code}</span></td>
                <td>${session.ip_address}</td>
                <td>${new Date(session.timestamp).toLocaleDateString()}</td>
                <td><button class="btn btn-sm" onclick="revokeSession('${session.token}')">Revoke</button></td>
            </tr>
        `).join('') : '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No active sessions</td></tr>';

        const recentTasks = data.user.tasks?.slice(0, 5) || [];
        document.getElementById('recentActivity').innerHTML = recentTasks.length ? recentTasks.map(task => `
            <div class="task-item" onclick="viewTaskDetails('${task._id}')">
                <div style="display:flex;justify-content:space-between;align-items:start">
                    <div>
                        <div style="font-weight:600">${task.url}</div>
                        <div style="font-size:.875rem;color:var(--text-light);margin-top:.25rem">
                            ${task.keywords_count} keywords ‚Ä¢ $${task.total_charge} budget ‚Ä¢ ${task.views_count} views
                        </div>
                    </div>
                    <div class="badge badge-${task.remaining_percentage > 50 ? 'success' : task.remaining_percentage > 20 ? 'warning' : 'error'}">
                        ${task.remaining_percentage}% left
                    </div>
                </div>
            </div>
        `).join('') : '<div class="empty-state"><p>No active tasks yet</p></div>';

        createDashboardCharts(data.user.tasks || []);
    } catch (error) {
        console.error('Dashboard error:', error);
    }
}

function createDashboardCharts(tasks) {
    const taskData = tasks.slice(0, 10);
    
    if (charts.tasks) charts.tasks.destroy();
    const ctx1 = document.getElementById('tasksChart').getContext('2d');
    charts.tasks = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: taskData.map(t => new URL(t.url).hostname),
            datasets: [{
                label: 'Views',
                data: taskData.map(t => t.views_count),
                backgroundColor: 'rgba(59, 130, 246, 0.8)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    const countryData = tasks.reduce((acc, task) => {
        if (task.country_visits) {
            Object.entries(task.country_visits).forEach(([country, count]) => {
                acc[country] = (acc[country] || 0) + count;
            });
        }
        return acc;
    }, {});

    if (charts.country) charts.country.destroy();
    const ctx2 = document.getElementById('countryChart').getContext('2d');
    charts.country = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: Object.keys(countryData).slice(0, 5),
            datasets: [{
                data: Object.values(countryData).slice(0, 5),
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
    });
}

async function loadTasks() {
    try {
        const { data } = await api('/users/dashboard?page=1&page_size=50');
        currentData.tasks = data.user.tasks || [];

        document.getElementById('taskStats').innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Active Tasks</div>
                <div class="stat-value">${data.user.usage_summary.active_tasks}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Views</div>
                <div class="stat-value">${data.user.task_statistics.total_views}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Available Budget</div>
                <div class="stat-value">$${data.user.task_statistics.available_charge.toFixed(2)}</div>
            </div>
        `;

        const tasksList = document.getElementById('tasksList');
        if (currentData.tasks.length) {
            tasksList.innerHTML = currentData.tasks.map(task => `
                <div class="task-item" onclick="viewTaskDetails('${task._id}')">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="flex:1">
                            <h4 style="margin:0 0 .5rem">${task.url}</h4>
                            <div style="display:flex;gap:1rem;flex-wrap:wrap">
                                <span class="badge badge-primary">${task.keywords_count} keywords</span>
                                <span class="badge badge-warning">${task.views_count} views</span>
                                <span class="badge badge-${task.task_priority === 0.15 ? 'error' : task.task_priority === 0.12 ? 'warning' : 'primary'}">
                                    ${task.task_priority === 0.15 ? 'Premium' : task.task_priority === 0.12 ? 'Standard' : 'Basic'}
                                </span>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div class="badge badge-${task.remaining_percentage > 50 ? 'success' : task.remaining_percentage > 20 ? 'warning' : 'error'}">
                               ${task.remaining_percentage}% left
                           </div>
                           <button class="btn btn-sm" style="margin-top:.5rem" onclick="event.stopPropagation();rechargeTask(['${task._id}'])">Recharge</button>
                       </div>
                   </div>
               </div>
           `).join('');
       } else {
           tasksList.innerHTML = '<div class="empty-state"><p>No SEO tasks created yet</p><button class="btn btn-primary" onclick="showTaskModal()">Create Your First Task</button></div>';
       }
   } catch (error) {
       console.error('Tasks error:', error);
   }
}

async function viewTaskDetails(taskId) {
   try {
       const { data } = await api('/get-task-details', { method: 'POST', body: JSON.stringify({ task_id: taskId }) });
       
       showModal('Task Details', `
           <div class="stat-grid" style="margin-bottom:1.5rem">
               <div class="stat-card">
                   <div class="stat-label">Total Budget</div>
                   <div class="stat-value">$${data.total_charge}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Available</div>
                   <div class="stat-value">$${data.available_charge}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Total Views</div>
                   <div class="stat-value">${Object.values(data.country_visits || {}).reduce((a,b) => a+b, 0)}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Keywords</div>
                   <div class="stat-value">${data.keywords.length}</div>
               </div>
           </div>

           <div style="margin-bottom:1.5rem">
               <h4>Task Information</h4>
               <div style="display:grid;gap:.5rem;margin-top:1rem">
                   <div><strong>URL:</strong> <a href="${data.url}" target="_blank" style="color:var(--primary)">${data.url}</a></div>
                   <div><strong>Created:</strong> ${new Date(data.date_created).toLocaleString()}</div>
                   <div><strong>Priority:</strong> ${data.task_priority === 0.15 ? 'Premium ($0.15)' : data.task_priority === 0.12 ? 'Standard ($0.12)' : 'Basic ($0.10)'}</div>
                   <div><strong>Keywords:</strong> ${data.keywords.map(k => `<span class="badge badge-primary">${k}</span>`).join(' ')}</div>
                   <div><strong>Locations:</strong> ${data.html_locations?.length || 0} selected</div>
               </div>
           </div>

           <div style="margin-bottom:1.5rem">
               <h4>Country Distribution</h4>
               <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.5rem;margin-top:.5rem">
                   ${Object.entries(data.country_visits || {}).map(([country, visits]) => 
                       `<div class="badge badge-primary">${country}: ${visits}</div>`
                   ).join('')}
               </div>
           </div>

           <div style="display:flex;gap:1rem;margin-top:1.5rem">
               <button class="btn btn-primary" onclick="rechargeTask(['${taskId}'])">Recharge Task</button>
               <button class="btn" onclick="closeModal()">Close</button>
           </div>
       `);
   } catch (error) {
       console.error('Task details error:', error);
   }
}

async function showTaskModal() {
   showModal('Create New SEO Task', `
       <div id="taskStep1">
           <div class="form-group">
               <label class="form-label">Website URL</label>
               <input type="url" class="form-input" id="taskUrl" placeholder="https://example.com" required>
           </div>
           <button class="btn btn-primary" onclick="loadTaskStep2()">Next: Select Locations</button>
       </div>

       <div id="taskStep2" style="display:none">
           <div class="location-preview">
               <iframe id="taskPreview"></iframe>
               <div class="location-overlay" id="locationOverlay"></div>
           </div>
           <div style="margin:1rem 0">
               <strong>Selected Locations:</strong>
               <div id="selectedLocations" style="margin-top:.5rem"></div>
           </div>
           <button class="btn btn-primary" onclick="loadTaskStep3()">Next: Keywords & Settings</button>
       </div>

       <div id="taskStep3" style="display:none">
           <div class="form-group">
               <label class="form-label">Keywords (comma separated)</label>
               <input type="text" class="form-input" id="taskKeywords" placeholder="SEO, optimization, marketing">
               <button class="btn btn-sm" style="margin-top:.5rem" onclick="suggestKeywords()">ü§ñ AI Suggest</button>
               <div class="keyword-grid" id="keywordSuggestions"></div>
           </div>

           <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
               <div class="form-group">
                   <label class="form-label">Task Priority</label>
                   <select class="form-select" id="taskPriority" onchange="updatePricing()">
                       <option value="basic">Basic ($0.10/click)</option>
                       <option value="standard" selected>Standard ($0.12/click)</option>
                       <option value="premium">Premium ($0.15/click)</option>
                   </select>
               </div>
               <div class="form-group">
                   <label class="form-label">Total Budget ($)</label>
                   <input type="number" class="form-input" id="taskBudget" min="10" value="150" onchange="updatePricing()">
               </div>
           </div>

           <div class="card" style="background:var(--input-bg);padding:1rem">
               <div style="display:flex;justify-content:space-between;margin-bottom:.5rem">
                   <span>Estimated Clicks:</span>
                   <strong id="estimatedClicks">1250</strong>
               </div>
               <div style="display:flex;justify-content:space-between">
                   <span>Max HTML Locations:</span>
                   <strong id="maxLocations">3</strong>
               </div>
           </div>

           <button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="createTask()">Create Task & Pay</button>
       </div>
   `);

   currentData.taskLocations = [];
   currentData.selectedKeywords = [];
}

function loadTaskStep2() {
   const url = document.getElementById('taskUrl').value;
   if (!url) {
       showToast('Please enter a valid URL', 'error');
       return;
   }

   document.getElementById('taskStep1').style.display = 'none';
   document.getElementById('taskStep2').style.display = 'block';

   const iframe = document.getElementById('taskPreview');
   iframe.src = url;

   iframe.onload = () => {
       const overlay = document.getElementById('locationOverlay');
       overlay.addEventListener('click', (e) => {
           const rect = overlay.getBoundingClientRect();
           const x = e.clientX - rect.left;
           const y = e.clientY - rect.top;

           const marker = document.createElement('div');
           marker.className = 'location-marker';
           marker.style.left = x + 'px';
           marker.style.top = y + 'px';
           overlay.appendChild(marker);

           const xpath = generateXPath(x / rect.width * 100, y / rect.height * 100, currentData.taskLocations.length + 1);
           currentData.taskLocations.push(xpath);
           updateSelectedLocations();
           
           gsap.from(marker, {duration: 0.3, scale: 0, ease: "back.out(1.7)"});
       });
   };
}

function generateXPath(x, y, index) {
   const sections = ['/html/body/header//a', '/html/body/nav//a', '/html/body/main//a', '/html/body/footer//a'];
   let sectionIndex = Math.floor((y / 100) * sections.length);
   if (sectionIndex >= sections.length) sectionIndex = sections.length - 1;
   return `${sections[sectionIndex]}[${index}]`;
}

function updateSelectedLocations() {
   document.getElementById('selectedLocations').innerHTML = currentData.taskLocations.map((loc, idx) => `
       <div class="badge badge-primary" style="margin-right:.5rem">
           ${loc} <span style="cursor:pointer;margin-left:.5rem" onclick="removeLocation(${idx})">√ó</span>
       </div>
   `).join('');
}

function removeLocation(idx) {
   currentData.taskLocations.splice(idx, 1);
   updateSelectedLocations();
   const markers = document.querySelectorAll('.location-marker');
   if (markers[idx]) {
       gsap.to(markers[idx], {duration: 0.3, scale: 0, ease: "back.in(1.7)", onComplete: () => markers[idx].remove()});
   }
}

function loadTaskStep3() {
   if (currentData.taskLocations.length === 0) {
       showToast('Please select at least one location', 'error');
       return;
   }

   document.getElementById('taskStep2').style.display = 'none';
   document.getElementById('taskStep3').style.display = 'block';
   gsap.from('#taskStep3', {duration: 0.5, opacity: 0, x: 20});
   updatePricing();
}

async function suggestKeywords() {
   const url = document.getElementById('taskUrl').value;
   const btn = event.target;
   btn.disabled = true;
   btn.innerHTML = '<span class="loader"></span> Loading...';

   try {
       const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
           headers: { 'Session-Token': sessionToken }
       });
       const data = await response.json();

       const suggestions = document.getElementById('keywordSuggestions');
       suggestions.innerHTML = data.keywords.slice(0, 10).map(keyword => `
           <div class="keyword-item" onclick="toggleKeyword('${keyword}')">${keyword}</div>
       `).join('');

       gsap.from('.keyword-item', {duration: 0.3, y: 10, opacity: 0, stagger: 0.05});
   } catch (error) {
       showToast('Failed to get keyword suggestions', 'error');
   } finally {
       btn.disabled = false;
       btn.innerHTML = 'ü§ñ AI Suggest';
   }
}

function toggleKeyword(keyword) {
   const idx = currentData.selectedKeywords.indexOf(keyword);
   const element = event.target;
   
   if (idx === -1) {
       currentData.selectedKeywords.push(keyword);
       element.classList.add('selected');
       gsap.to(element, {duration: 0.2, scale: 1.05, ease: "back.out(1.7)"});
   } else {
       currentData.selectedKeywords.splice(idx, 1);
       element.classList.remove('selected');
       gsap.to(element, {duration: 0.2, scale: 1});
   }

   document.getElementById('taskKeywords').value = currentData.selectedKeywords.join(', ');
}

function updatePricing() {
   const priority = document.getElementById('taskPriority').value;
   const budget = parseFloat(document.getElementById('taskBudget').value) || 0;
   
   const rates = { basic: 0.10, standard: 0.12, premium: 0.15 };
   const maxLocs = { basic: 1, standard: 3, premium: 5 };
   
   const clicks = Math.floor(budget / rates[priority]);
   document.getElementById('estimatedClicks').textContent = clicks.toLocaleString();
   document.getElementById('maxLocations').textContent = maxLocs[priority];
}

async function createTask() {
   const keywords = document.getElementById('taskKeywords').value.split(',').map(k => k.trim()).filter(k => k);
   if (!keywords.length) {
       showToast('Please enter at least one keyword', 'error');
       return;
   }

   const priority = document.getElementById('taskPriority').value;
   const maxLocs = { basic: 1, standard: 3, premium: 5 };
   
   if (currentData.taskLocations.length > maxLocs[priority]) {
       showToast(`${priority} plan allows maximum ${maxLocs[priority]} locations`, 'error');
       return;
   }

   try {
       const { data } = await api('/add-task', {
           method: 'POST',
           body: JSON.stringify({
               task_details: {
                   url: document.getElementById('taskUrl').value,
                   keywords: keywords,
                   html_locations: currentData.taskLocations
               },
               task_priority: priority,
               total_charge: parseInt(document.getElementById('taskBudget').value),
               provider: 'stripe',
               is_subscription: false,
               cancel_previous: false
           })
       });

       window.open(data.payment_url, '_blank');
       closeModal();
       showToast('Redirecting to payment...', 'success');
       setTimeout(() => loadTasks(), 2000);
   } catch (error) {
       console.error('Create task error:', error);
   }
}

async function rechargeTask(taskIds) {
   const amount = prompt('Enter recharge amount ($):');
   if (!amount || isNaN(amount)) return;

   try {
       const { data } = await api('/recharge', {
           method: 'POST',
           body: JSON.stringify({
               task_ids: taskIds,
               payment_method: 'stripe',
               cancel_previous: false
           })
       });

       window.open(data.payment_url, '_blank');
       showToast('Redirecting to payment...', 'success');
   } catch (error) {
       console.error('Recharge error:', error);
   }
}

async function loadHosting() {
   try {
       const { data } = await api('/hosting/subscription-status');
       currentData.hostingStatus = data.data;
       showHostingContent('overview');
   } catch (error) {
       console.error('Hosting error:', error);
       showHostingContent('overview');
   }
}

async function showHostingContent(type) {
   document.querySelectorAll('.hosting-nav-item').forEach(item => item.classList.remove('active'));
   event?.target?.classList.add('active');

   const content = document.getElementById('hostingContent');
   
   switch(type) {
       case 'overview':
           const status = currentData.hostingStatus || { current_plan: 'free' };
           content.innerHTML = `
               <div class="stat-grid" style="margin-bottom:1.5rem">
                   <div class="stat-card">
                       <div class="stat-label">Current Plan</div>
                       <div class="stat-value">${status.current_plan?.toUpperCase() || 'FREE'}</div>
                   </div>
                   <div class="stat-card">
                       <div class="stat-label">Images Used</div>
                       <div class="stat-value">${status.images_uploads || 0}/${status.images_limit || 10}</div>
                   </div>
                   <div class="stat-card">
                       <div class="stat-label">Articles Used</div>
                       <div class="stat-value">${status.article_uploads || 0}/${status.articles_limit || 5}</div>
                   </div>
                   <div class="stat-card">
                       <div class="stat-label">Expires</div>
                       <div class="stat-value">${status.expiry_date ? new Date(status.expiry_date).toLocaleDateString() : 'N/A'}</div>
                   </div>
               </div>
               
               <div class="card">
                   <div class="card-header">
                       <h3>Upgrade Your Plan</h3>
                       <button class="btn btn-primary" onclick="showUpgradeModal()">Upgrade Now</button>
                   </div>
                   <div class="card-body">
                       <p>Upgrade to unlock more storage, images, and articles for your hosting needs.</p>
                       ${status.is_subscription ? `<button class="btn" onclick="cancelSubscription()">Cancel Subscription</button>` : ''}
                   </div>
               </div>
           `;
           break;
           
       case 'images':
           loadImages();
           break;
           
       case 'articles':
           loadArticles();
           break;
           
       case 'domains':
           loadDomains();
           break;
   }
   
   gsap.from(content.children, {duration: 0.5, y: 20, opacity: 0, stagger: 0.1});
}

async function loadImages() {
   try {
       const { data } = await api('/images/dashboard?page=1&page_size=50');
       const content = document.getElementById('hostingContent');
       
       content.innerHTML = `
           <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
               <h3>Image Management (${data.user.uploaded}/${data.user.uploaded + data.user.remaining} used)</h3>
               <button class="btn btn-primary" onclick="showImageUploadModal()">Upload Images</button>
           </div>
           ${data.images.length ? `
               <div class="image-grid">
                   ${data.images.map(img => `
                       <div class="image-item" onclick="viewImage('${img.image_id}')">
                           <img src="${img.cdn_url}" alt="${img.original_filename}">
                           <div class="image-stats">
                               <div>${img.total_views} views</div>
                               <div>${img.original_filename}</div>
                           </div>
                       </div>
                   `).join('')}
               </div>
           ` : '<div class="empty-state"><p>No images uploaded yet</p></div>'}
       `;
   } catch (error) {
       console.error('Images error:', error);
   }
}

async function loadArticles() {
   try {
       const { data } = await api('/dashboard/articles?page=1&page_size=50');
       const content = document.getElementById('hostingContent');
       
       content.innerHTML = `
           <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
               <h3>Articles (${data.user.uploaded}/${data.user.uploaded + data.user.remaining} used)</h3>
               <button class="btn btn-primary" onclick="showArticleModal()">Create Article</button>
           </div>
           ${data.articles.length ? `
               <div>
                   ${data.articles.map(article => `
                       <div class="task-item" onclick="viewArticle('${article.article_id}')">
                           <div style="display:flex;justify-content:space-between;align-items:center">
                               <div>
                                   <h4 style="margin:0">${article.subject}</h4>
                                   <div style="font-size:.875rem;color:var(--text-light);margin-top:.25rem">
                                       ${article.url} ‚Ä¢ ${article.total_views} views ‚Ä¢ ${new Date(article.creation_date).toLocaleDateString()}
                                   </div>
                               </div>
                               <div style="display:flex;gap:.5rem">
                                   <button class="btn btn-sm" onclick="event.stopPropagation();editArticle('${article.article_id}')">Edit</button>
                                   <button class="btn btn-sm" onclick="event.stopPropagation();deleteArticle('${article.article_id}')">Delete</button>
                               </div>
                           </div>
                       </div>
                   `).join('')}
               </div>
           ` : '<div class="empty-state"><p>No articles published yet</p></div>'}
       `;
   } catch (error) {
       console.error('Articles error:', error);
   }
}

async function loadDomains() {
   try {
       const { data } = await api('/users/dashboard?page=1&page_size=1');
       const user = data.data.user;
       const domains = user.domains || [];
       
       const content = document.getElementById('hostingContent');
       content.innerHTML = `
           <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
               <h3>Domain Management</h3>
               <button class="btn btn-primary" onclick="showDomainModal()">Add Domain</button>
           </div>
           ${domains.length ? `
               <div>
                   ${domains.map(domain => `
                       <div class="domain-item ${domain.verified ? 'domain-verified' : ''}">
                           <div>
                               <div style="font-weight:600">${domain.url}</div>
                               <div style="font-size:.875rem;color:var(--text-light)">
                                   ${domain.verified ? '‚úì Verified' : 'Pending verification'}
                               </div>
                           </div>
                           ${!domain.verified ? `<button class="btn btn-sm" onclick="verifyDomain('${domain.url}')">Verify</button>` : ''}
                       </div>
                   `).join('')}
               </div>
           ` : '<div class="empty-state"><p>No domains configured yet</p></div>'}
       `;
   } catch (error) {
       console.error('Domains error:', error);
   }
}

async function showUpgradeModal() {
   showModal('Upgrade Hosting Plan', `
       <div style="display:grid;gap:1rem">
           <div class="card" style="cursor:pointer;transition:all .2s;padding:1.5rem" onclick="selectPlan('basic', '3month')">
               <h4>Basic Plan - 3 Months</h4>
               <div class="stat-value">$29.99</div>
               <p style="color:var(--text-light);margin-top:.5rem">100 images, 50 articles</p>
           </div>
           <div class="card" style="cursor:pointer;transition:all .2s;border:2px solid var(--primary);padding:1.5rem" onclick="selectPlan('pro', '6month')">
               <div class="badge badge-primary" style="position:absolute;top:1rem;right:1rem">Popular</div>
               <h4>Pro Plan - 6 Months</h4>
               <div class="stat-value">$99.99</div>
               <p style="color:var(--text-light);margin-top:.5rem">500 images, 200 articles</p>
           </div>
           <div class="card" style="cursor:pointer;transition:all .2s;padding:1.5rem" onclick="selectPlan('enterprise', '12month')">
               <h4>Enterprise Plan - 12 Months</h4>
               <div class="stat-value">$299.99</div>
               <p style="color:var(--text-light);margin-top:.5rem">Unlimited everything</p>
           </div>
       </div>
   `);
}

async function selectPlan(packageType, duration) {
   try {
       const { data } = await api('/hosting/buy-package', {
           method: 'POST',
           body: JSON.stringify({
               package: packageType,
               provider: 'stripe',
               duration: duration,
               subscription: true,
               cancel_previous: false,
               cancel_current_plan: false
           })
       });
       
       window.open(data.payment_url, '_blank');
       closeModal();
       showToast('Redirecting to payment...', 'success');
   } catch (error) {
       console.error('Package selection error:', error);
   }
}

async function cancelSubscription() {
   if (!confirm('Are you sure you want to cancel your subscription?')) return;
   
   try {
       await api('/hosting/cancel-subscription');
       showToast('Subscription cancelled successfully', 'success');
       loadHosting();
   } catch (error) {
       console.error('Cancel subscription error:', error);
   }
}

async function showImageUploadModal() {
   showModal('Upload Images', `
       <div class="form-group">
           <label class="form-label">Select images (max 10)</label>
           <input type="file" id="imageFiles" multiple accept="image/*" class="form-input">
       </div>
       <button class="btn btn-primary" onclick="uploadImages()">Upload</button>
   `);
}

async function uploadImages() {
   const files = document.getElementById('imageFiles').files;
   if (!files.length) {
       showToast('Please select files', 'error');
       return;
   }
   
   if (files.length > 10) {
       showToast('Maximum 10 files at once', 'error');
       return;
   }

   const formData = new FormData();
   for (let file of files) {
       formData.append('file', file);
   }

   try {
       const response = await fetch(`${API_BASE}/images/upload`, {
           method: 'POST',
           headers: { 'Session-Token': sessionToken },
           body: formData
       });
       
       const data = await response.json();
       if (!response.ok) throw new Error(data.error?.message || 'Upload failed');
       
       showToast(`${data.data.uploaded_images.length} images uploaded successfully`, 'success');
       closeModal();
       loadImages();
   } catch (error) {
       showToast(error.message, 'error');
   }
}

async function viewImage(imageId) {
   const img = currentData.images?.find(i => i.image_id === imageId);
   if (!img) return;
   
   showModal('Image Details', `
       <img src="${img.cdn_url}" style="width:100%;border-radius:var(--radius);margin-bottom:1rem">
       <div style="display:grid;gap:.5rem">
           <div><strong>Filename:</strong> ${img.original_filename}</div>
           <div><strong>Views:</strong> ${img.total_views}</div>
           <div><strong>Uploaded:</strong> ${new Date(img.upload_date).toLocaleDateString()}</div>
           <div><strong>CDN URL:</strong> <code style="font-size:.875rem">${img.cdn_url}</code></div>
       </div>
       <div style="display:flex;gap:1rem;margin-top:1rem">
           <button class="btn" onclick="copyToClipboard('${img.cdn_url}')">Copy URL</button>
           <button class="btn" onclick="deleteImages(['${imageId}'])">Delete</button>
       </div>
   `);
}

async function deleteImages(imageIds) {
   if (!confirm('Delete selected images?')) return;
   
   try {
       await api('/images', {
           method: 'DELETE',
           body: JSON.stringify({ image_ids: imageIds })
       });
       
       showToast('Images deleted successfully', 'success');
       closeModal();
       loadImages();
   } catch (error) {
       console.error('Delete images error:', error);
   }
}

async function showArticleModal() {
   showModal('Create Article', `
       <div class="form-group">
           <label class="form-label">URL (must be verified domain)</label>
           <input type="text" class="form-input" id="articleUrl" placeholder="example.com/blog">
       </div>
       <div class="form-group">
           <label class="form-label">Subject</label>
           <input type="text" class="form-input" id="articleSubject" placeholder="Article Title">
       </div>
       <div class="form-group">
           <label class="form-label">Body (HTML)</label>
           <textarea class="form-textarea" id="articleBody" rows="10" placeholder="<p>Article content...</p>"></textarea>
       </div>
       <div class="form-group">
           <label class="form-label">Images (max 10)</label>
           <input type="file" id="articleImages" multiple accept="image/*" class="form-input">
       </div>
       <button class="btn btn-primary" onclick="createArticle()">Create Article</button>
   `);
}

async function createArticle() {
   const url = document.getElementById('articleUrl').value;
   const subject = document.getElementById('articleSubject').value;
   const body = document.getElementById('articleBody').value;
   const files = document.getElementById('articleImages').files;

   if (!url || !subject || !body || !files.length) {
       showToast('All fields are required', 'error');
       return;
   }

   const formData = new FormData();
   formData.append('url', url);
   formData.append('subject', subject);
   formData.append('body', body);
   
   for (let file of files) {
       formData.append('image_data', file);
   }

   try {
       const response = await fetch(`${API_BASE}/add-article`, {
           method: 'POST',
           headers: { 'Session-Token': sessionToken },
           body: formData
       });

       const data = await response.json();
       if (!response.ok) throw new Error(data.error?.message || 'Failed to create article');

       showToast('Article created successfully', 'success');
       closeModal();
       loadArticles();
   } catch (error) {
       showToast(error.message, 'error');
   }
}

async function viewArticle(articleId) {
   try {
       const { data } = await api(`/dashboard/articles?article_id=${articleId}`);
       const article = data.article;
       
       showModal('Article Details', `
           <h3>${article.subject}</h3>
           <div style="margin:1rem 0">
               <strong>URL:</strong> <a href="https://${article.url}" target="_blank" style="color:var(--primary)">${article.url}</a>
           </div>
           <div style="border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:1rem;max-height:300px;overflow-y:auto">
               ${article.body}
           </div>
           <div style="margin-bottom:1rem">
               <strong>Images:</strong>
               <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:.5rem;margin-top:.5rem">
                 ${article.images.map(img => `<img src="${img}" style="width:100%;border-radius:var(--radius);cursor:pointer" onclick="window.open('${img}')">`).join('')}
               </div>
           </div>
           <div class="stat-grid">
               <div class="stat-card">
                   <div class="stat-label">Total Views</div>
                   <div class="stat-value">${article.total_views}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Created</div>
                   <div class="stat-value">${new Date(article.creation_date).toLocaleDateString()}</div>
               </div>
           </div>
       `);
   } catch (error) {
       console.error('View article error:', error);
   }
}

async function editArticle(articleId) {
   try {
       const { data } = await api(`/dashboard/articles?article_id=${articleId}`);
       const article = data.article;
       
       showModal('Edit Article', `
           <div class="form-group">
               <label class="form-label">Subject</label>
               <input type="text" class="form-input" id="editSubject" value="${article.subject}">
           </div>
           <div class="form-group">
               <label class="form-label">Body (HTML)</label>
               <textarea class="form-textarea" id="editBody" rows="10">${article.body}</textarea>
           </div>
           <div class="form-group">
               <label class="form-label">Add New Images</label>
               <input type="file" id="editImages" multiple accept="image/*" class="form-input">
           </div>
           <button class="btn btn-primary" onclick="updateArticle('${articleId}')">Update Article</button>
       `);
   } catch (error) {
       console.error('Edit article error:', error);
   }
}

async function updateArticle(articleId) {
   const formData = new FormData();
   formData.append('subject', document.getElementById('editSubject').value);
   formData.append('body', document.getElementById('editBody').value);
   
   const files = document.getElementById('editImages').files;
   for (let file of files) {
       formData.append('image_data', file);
   }

   try {
       const response = await fetch(`${API_BASE}/edit-article/${articleId}`, {
           method: 'PUT',
           headers: { 'Session-Token': sessionToken },
           body: formData
       });

       const data = await response.json();
       if (!response.ok) throw new Error(data.message || 'Update failed');

       showToast('Article updated successfully', 'success');
       closeModal();
       loadArticles();
   } catch (error) {
       showToast(error.message, 'error');
   }
}

async function deleteArticle(articleId) {
   if (!confirm('Delete this article and all its images?')) return;
   
   try {
       await api(`/delete-article/${articleId}`, { method: 'DELETE' });
       showToast('Article deleted successfully', 'success');
       loadArticles();
   } catch (error) {
       console.error('Delete article error:', error);
   }
}

async function showDomainModal() {
   showModal('Add Domain', `
       <div class="form-group">
           <label class="form-label">Domain URL</label>
           <input type="text" class="form-input" id="domainUrl" placeholder="example.com/blog">
       </div>
       <button class="btn btn-primary" onclick="addDomain()">Add Domain</button>
   `);
}

async function addDomain() {
   const url = document.getElementById('domainUrl').value;
   if (!url) {
       showToast('Please enter a domain', 'error');
       return;
   }

   try {
       const { data } = await api('/add-domain', {
           method: 'POST',
           body: JSON.stringify({ url })
       });

       if (data.txt_record) {
           showModal('Domain Verification', `
               <h4>Domain added successfully!</h4>
               <p>Please add the following TXT record to your DNS:</p>
               <div style="background:var(--input-bg);padding:1rem;border-radius:var(--radius);margin:1rem 0">
                   <code>${data.txt_record}</code>
               </div>
               <button class="btn" onclick="copyToClipboard('${data.txt_record}')">Copy TXT Record</button>
               <button class="btn btn-primary" onclick="verifyDomain('${url}')">Verify Now</button>
           `);
       } else {
           showToast('Domain added and verified successfully', 'success');
           closeModal();
           loadDomains();
       }
   } catch (error) {
       console.error('Add domain error:', error);
   }
}

async function verifyDomain(url) {
   try {
       await api('/verify-domain', {
           method: 'POST',
           body: JSON.stringify({ url })
       });
       
       showToast('Domain verified successfully', 'success');
       closeModal();
       loadDomains();
   } catch (error) {
       if (error.message.includes('TXT record')) {
           showToast('Domain verification failed. Please check your DNS records.', 'error');
       }
   }
}

async function loadBilling(type = 'all') {
   try {
       const { data } = await api(`/dashboard/billings?page=1&limit=50&type=${type}`);
       
       const allPayments = [...(data.tasks || []), ...(data.hosting || [])];
       const filteredPayments = type === 'all' ? allPayments : (type === 'tasks' ? data.tasks : data.hosting);

       const stats = {
           total: filteredPayments.length,
           paid: filteredPayments.filter(p => p.status === 'Paid').length,
           amount: filteredPayments.reduce((sum, p) => sum + (p.total_payment || 0), 0),
           fees: filteredPayments.reduce((sum, p) => sum + (p.provider_fee || 0) + (p.platform_fee || 0), 0)
       };

       document.getElementById('billingStats').innerHTML = `
           <div class="stat-card">
               <div class="stat-label">Total Transactions</div>
               <div class="stat-value">${stats.total}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Completed</div>
               <div class="stat-value">${stats.paid}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Total Amount</div>
               <div class="stat-value">$${stats.amount.toFixed(2)}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Total Fees</div>
               <div class="stat-value">$${stats.fees.toFixed(2)}</div>
           </div>
       `;

       const tbody = document.getElementById('billingTable');
       tbody.innerHTML = filteredPayments.length ? filteredPayments.map(payment => `
           <tr>
               <td>${new Date(payment.dates?.created || payment.dates?.paid).toLocaleDateString()}</td>
               <td>
                   <span class="badge badge-${payment.method === 'create_task' ? 'primary' : payment.method === 'recharge' ? 'warning' : 'success'}">
                       ${payment.method.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                   </span>
               </td>
               <td>${payment.details?.url || payment.details?.package || payment.method}</td>
               <td>$${(payment.total_payment || 0).toFixed(2)}</td>
               <td>
                   <span class="badge badge-${payment.status === 'Paid' ? 'success' : payment.status === 'cancelled' ? 'error' : 'warning'}">
                       ${payment.status}
                   </span>
               </td>
               <td>
                   <button class="btn btn-sm" onclick="viewPayment('${payment.billing_id}')">View</button>
               </td>
           </tr>
       `).join('') : '<tr><td colspan="6" style="text-align:center">No transactions found</td></tr>';

       currentData.billingData = data;
   } catch (error) {
       console.error('Billing error:', error);
   }
}

async function viewPayment(paymentId) {
   try {
       const { data } = await api(`/get-payment-status?payment_id=${paymentId}`);
       
       showModal('Payment Details', `
           <div class="stat-grid" style="margin-bottom:1rem">
               <div class="stat-card">
                   <div class="stat-label">Amount</div>
                   <div class="stat-value">$${data.amount.toFixed(2)}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Status</div>
                   <div class="stat-value">
                       <span class="badge badge-${data.status === 'Paid' ? 'success' : 'warning'}">${data.status}</span>
                   </div>
               </div>
           </div>

           <div style="display:grid;gap:.5rem">
               <div><strong>Type:</strong> ${data.type}</div>
               <div><strong>Date:</strong> ${new Date(data.date_of_payment).toLocaleString()}</div>
               <div><strong>Provider:</strong> ${data.payment_method}</div>
               <div><strong>Invoice:</strong> <code style="font-size:.875rem">${data.invoice_number}</code></div>
               ${data.transaction_id ? `<div><strong>Transaction ID:</strong> <code style="font-size:.875rem">${data.transaction_id}</code></div>` : ''}
               ${data.task_id ? `<div><strong>Task ID:</strong> ${data.task_id}</div>` : ''}
               ${data.package ? `<div><strong>Package:</strong> ${data.package} (${data.duration})</div>` : ''}
           </div>

           <button class="btn" style="margin-top:1rem;width:100%" onclick="closeModal()">Close</button>
       `);
   } catch (error) {
       console.error('Payment details error:', error);
   }
}

async function analyzeKeywords() {
   const url = document.getElementById('keywordUrl').value;
   if (!url) {
       showToast('Please enter a URL', 'error');
       return;
   }

   const btn = event.target;
   btn.disabled = true;
   btn.innerHTML = '<span class="loader"></span> Analyzing...';

   try {
       const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
           headers: { 'Session-Token': sessionToken }
       });
       const data = await response.json();

       document.getElementById('keywordResults').innerHTML = `
           <div class="card" style="margin-top:1.5rem">
               <div class="card-body">
                   <h4>Keyword Analysis Results</h4>
                   <div style="margin-top:1rem">
                       <strong>Top Keywords:</strong>
                       <div class="keyword-grid">
                           ${data.keywords.map(kw => `<span class="badge badge-primary">${kw}</span>`).join('')}
                       </div>
                   </div>
                   ${data.density ? `
                       <div style="margin-top:1rem">
                           <strong>Keyword Density:</strong>
                           <div style="margin-top:.5rem">
                               ${Object.entries(data.density).map(([kw, density]) => 
                                   `<div style="display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--border)">
                                       <span>${kw}</span>
                                       <span class="badge badge-primary">${density}%</span>
                                   </div>`
                               ).join('')}
                           </div>
                       </div>
                   ` : ''}
               </div>
           </div>
       `;
   } catch (error) {
       showToast('Failed to analyze keywords', 'error');
   } finally {
       btn.disabled = false;
       btn.innerHTML = 'Analyze';
   }
}

async function checkSerpPosition() {
   const keyword = document.getElementById('serpKeyword').value;
   const url = document.getElementById('serpUrl').value;

   if (!keyword || !url) {
       showToast('Please enter both keyword and URL', 'error');
       return;
   }

   const btn = event.target;
   btn.disabled = true;
   btn.innerHTML = '<span class="loader"></span> Checking...';

   try {
       const response = await fetch(`https://search.seotize.workers.dev/?keyword=${encodeURIComponent(keyword)}&url=${encodeURIComponent(url)}`, {
           headers: { 'Session-Token': sessionToken }
       });
       const data = await response.json();

       document.getElementById('serpResults').innerHTML = `
           <div class="card">
               <div class="card-body">
                   <h4>SERP Results for "${keyword}"</h4>
                   <div class="stat-grid" style="margin-top:1rem">
                       <div class="stat-card">
                           <div class="stat-label">Position</div>
                           <div class="stat-value">${data.position || 'Not Found'}</div>
                       </div>
                       <div class="stat-card">
                           <div class="stat-label">Page</div>
                           <div class="stat-value">${data.page || 'N/A'}</div>
                       </div>
                   </div>

                   ${data.competitors?.length ? `
                       <div style="margin-top:1.5rem">
                           <h5>Top Competitors:</h5>
                           <div style="margin-top:.5rem">
                               ${data.competitors.slice(0, 5).map(comp => `
                                   <div style="padding:.5rem 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between">
                                       <a href="${comp.url}" target="_blank" style="color:var(--primary);text-decoration:none">${comp.url}</a>
                                       <span class="badge badge-primary">#${comp.position}</span>
                                   </div>
                               `).join('')}
                           </div>
                       </div>
                   ` : ''}
               </div>
           </div>
       `;
   } catch (error) {
       showToast('Failed to check SERP position', 'error');
   } finally {
       btn.disabled = false;
       btn.innerHTML = 'Check Position';
   }
}

function showModal(title, content) {
   document.getElementById('modalTitle').textContent = title;
   document.getElementById('modalBody').innerHTML = content;
   document.getElementById('modal').classList.add('show');
   gsap.from('.modal-content', {duration: 0.3, scale: 0.9, opacity: 0, ease: "back.out(1.7)"});
}

function closeModal() {
   document.getElementById('modal').classList.remove('show');
}

function showToast(message, type = 'success') {
   const toast = document.getElementById('toast');
   toast.textContent = message;
   toast.className = `toast ${type} show`;
   setTimeout(() => toast.classList.remove('show'), 3000);
}

function copyToClipboard(text) {
   navigator.clipboard.writeText(text).then(() => {
       showToast('Copied to clipboard', 'success');
   }).catch(() => {
       showToast('Failed to copy', 'error');
   });
}

function getCookie(name) {
   const value = `; ${document.cookie}`;
   const parts = value.split(`; ${name}=`);
   return parts.length === 2 ? parts.pop().split(';').shift() : '';
}

async function logout() {
   try {
       await api('/logout');
   } finally {
       document.cookie = 'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
       window.location.href = '/login.html';
   }
}

function revokeSession(token) {
   showToast('Session revoked', 'success');
   loadDashboard();
}

document.addEventListener('DOMContentLoaded', () => {
   const savedTheme = localStorage.getItem('theme') || 'dark';
   document.body.dataset.theme = savedTheme;
});

document.getElementById('modal').addEventListener('click', e => {
   if (e.target === e.currentTarget) closeModal();
});

document.addEventListener('keydown', e => {
   if (e.key === 'Escape') closeModal();
});
</script>
</body>
</html>
